# C4模型 - 可视化架构设计

## 一、 简介及参考

`C4模型`是一种使用简单图形符号表达软件架构的方法模型。相比于`Unified Modeling Language (UML)`、`ArchiMate`和`SysML`等传统架构设计软件，其最大的优点就是使用极为简单的图形符号对架构进行分级描述，使用非技术人员与技术人员、架构师和程序员、开发人员和维护人员均能比较直观地对系统进行理解。

事实上，`UML`和`SysML`等工具更为专业，但同时也更为复杂。许多软件团队成员与用户并不能充分理解这些工具所用图形符号的含意，造成各系统的各个参与方无法通过图形对系统进行有效的分析与交流。

`C4模型`（`C4 model`）由`Simon Brown`发明的一种架构图画法，目标就是简单得可以使各方参与人员均能快速理解设计图并有效交流。

以下为参考资料：

* [The C4 model for visualizing software architecture](https://c4model.com/)，官方网站。本方翻译并重新组织了文档内容。
* [用于软件架构的 C4 模型](https://www.infoq.cn/article/C4-architecture-model/)，官网上提供的中文链接，但少了许多内容，只有对于`C4模型`所谓4层结构的翻译。
* [C4 Model, Architecture Viewpoint and Archi 4.7](https://www.archimatetool.com/blog/2020/04/18/c4-model-architecture-viewpoint-and-archi-4-7/)，官网提供的使用`ArchiMate`工具画`C4模型`图的说明。
* [可视化架构设计——C4介绍](https://www.jianshu.com/p/33c6a7ed126f)，对`C4模型`比较好的翻译及介绍，有作者自己的使用体会及分析。
* [Java进阶架构师之如何画好架构图](https://www.jianshu.com/p/dfc897c5322b)，另外一篇比较好的介绍，还对比了其它形式的架构图。

## 二、 基本教程

### 2.1 C4模型的图形符号

`C4模型`不使用特定的图形符号：

![C4图形符号](https://c4model.com/img/bigbankplc-Containers-key.png)

使用时可以为以上符号加上颜色，或为长方形加上圆角等，以使用软件图形更为突出，便于理解。
所有符号都应该能够自描述，否则应加上文字说明，因为不是每个人都知道所使用的符号。`Mobile App`和`Web Browser`也可以不画得这么复杂，直接使用方框或圆角方框即可。

图中的每个符号，都应该满足[C4图形符号检查表](https://c4model.com/review/)中的检查项：所有检查项均为`Yes`。

### 2.2 C4模型内容及层次结构

#### 2.2.1 Person

`Person`即`UML用例图`中的`Role`，是使用系统的人员或角色。

#### 2.2.2 Software System

`Software System`即`软件系统`，是最高层次的抽象。它描述整个系统可以为用户提供的功能，不管这些用户是人还是其它软件系统。它包含正在建模的软件系统，以及当前系统所依赖的其他软件系统。大多数情况下，一个软件系统补一个软件开发团队所“拥有”。

#### 2.2.3 Container

`Container`即`容器`。但此处的容器不是`Docker`中的容器，而是代表一个可运行的应用程序或数据存储。运行的容器支持了整个软件系统正常工作。在现实环境中，容器有以下类型：

* 服务器端Web程序：运行在Tomcat上的Java程序、在Windows/Linux上运行的ASP.NET程序、Node.js程序等。
* 客户端Web程序：使用诸如Angular、jQuery等架构的运行在浏览器中的javascript应用。
* 客户端桌面程序：使用WPF编写的Windows桌面程序、使用Qt编写的跨平台桌面程序等。
* 移动应用：在iOS或Android上运行的程序。
* 服务器端命令行程序：在操作系统中独立运行的应用程序。
* Serverless函数：如Amazon Lambda及Azure Function等。
* 数据库：关系型或NoSQL等数据库。
* 内容存储系统：如Amazon S3、Azure Blob Storage及Amazon CloudFront等。
* 文件系统：本地或网络文件系统，如SAN或NAS等。
* 脚本：如运行在Bash中的脚本。
* 等等，不一一列举。

#### 2.2.4 Component

`Component`即`组件`。组件是软件开发行业使用最多的词汇之一。但在`C4模型`中，组件是一组接口明确的功能组合。如果使用`java`或`C#`，可以把组件基本等同于jar包或dll动态库。

需要注意的是，在`C4模型`中，组件是不能单独发布运行的，它是容器的组成部分。

#### 2.2.5 层次结构

![层次图1](https://c4model.com/img/abstractions.png)

在`C4模型`中，`软件系统`由一个或多个`容器`（web应用程序、移动应用程序、桌面应用程序、数据库、文件系统等）组成。每个`容器`包含一个或多个`组件`，这些`组件`又由一组或多组`代码`（例如类、接口、对象、函数等）实现。

![层次图2](https://c4model.com/img/model.png)

以上是一个可视化软件架构模型示例。它显示了构成静态结构的元素的层次结构。

### 2.3 核心图

#### 2.3.1 第一层：System Context diagram，概念图

##### 2.3.1.1 定义

`概念图`是绘制和记录软件系统的起点，可以看到系统全局。将核心系统显示为图中心的一个方框，周围是它的用户和与之交互的其他系统。

技术细节在这里并不重要，因为这是一个放大的图，显示了整个系统的全景图。重点应该放在人（参与者、角色等）和软件系统上，而不是技术、协议和其他低级细节。这是一种可以向非技术人员展示的图表。

* **应用范围**：单独的软件系统。
* **主要元素**：在系统范围内直接连接到软件系统的人员（例如用户、参与者、角色）和软件系统（外部依赖）。通常，这些其他软件系统位于当前软件系统的范围或边界之外，当前系统对它们没有责任或所有权。
* **目标受众**：软件开发团队内外的所有人，包括技术人员和非技术人员。

##### 2.3.1.2 示例

以下是一个虚构的网上银行系统的概念图。它显示了使用它的人，以及与网上银行系统有关系的其他软件系统。银行的个人客户使用网上银行系统查看有关其银行账户的信息，并进行支付。网上银行系统本身使用银行现有的主机银行系统来完成这项工作，并使用银行现有的电子邮件系统向客户发送电子邮件。使用不同的颜色标记已经存在的软件系统（灰色框）。

![System Context diagram](https://c4model.com/img/bigbankplc-SystemContext.png)

在这个稍加修改的示例中，虚线表示银行的边界，并用于说明银行的内部与外部。

![System Context diagram with boarder](https://c4model.com/img/bigbankplc-SystemContext-with-enterprise-boundary.png)

#### 2.3.2 第二层：Container diagram，容器图

##### 2.3.2.1 定义

一旦了解了当前系统如何适应整个IT环境，下一个非常有用的步骤是使用容器图放大系统边界。`容器`类似于服务器端web应用程序、单页应用程序、桌面应用程序、移动应用程序、数据库、文件系统等。本质上，容器是一个单独运行/可部署的单元，执行代码或存储数据。

`容器图`显示了软件体系结构中如何分配职责。它还显示了主要的技术选择以及容器如何相互通信。这是一个简单的、以技术为中心的高级图，对软件开发人员和支持/操作人员都很有用。

* **应用范围**：单独的软件系统。
* **主要元素**：当前软件系统内的容器。
* **支撑元素**：与当前软件系统直接相关人员或其它软件系统。
* **目标受众**：软件开发团队内外的技术人员；包括软件架构师、开发人员和操作/支持人员。
* **注意**：该图不说明部署场景、集群、复制、故障转移等内容。

##### 2.3.2.2 示例

这是一个虚构的网上银行系统的容器图。它显示了网上银行系统（虚线框）由五个容器组成：服务器端Web应用程序、单页应用程序、移动应用程序、服务器端API应用程序和数据库。Web应用程序是一个Java/Spring MVC WEB应用程序，它只提供静态内容（HTML、CSS和JavaScript），包括构成单个页面应用程序的内容。单页应用程序是一个Angular应用程序，运行在客户的web浏览器中，提供所有的网上银行功能。替代方案是客户可以使用跨平台Xamarin移动应用程序来访问网上银行功能的一个子集。

单页应用程序和移动应用程序都使用JSON/HTTPS API，该API由运行在服务器上的另一个Java/Spring MVC应用程序提供。API应用程序从数据库获取用户信息。API应用程序还使用专有的XML/HTTPS接口与现有的大型机银行系统通信，以获取有关银行帐户的信息或进行交易。如果需要向客户发送电子邮件，API应用程序还使用现有的电子邮件系统。

虚线表示网上银行系统的边界，显示其中的容器（浅蓝色）。此外，还使用了一个圆柱体形状来表示数据库。

![Container diagram](https://c4model.com/img/bigbankplc-Containers.png)

#### 2.3.3 第三层：Component diagram，组件图

##### 2.3.3.1 定义

接下来以进一步放大并分解到每个容器，以确定主要的构建结构及其交互作用。

`组件图`显示了容器是如何由许多`组件`组成的，每个组件是什么，它们的职责以及技术/实现细节。

* **应用范围**：单独的容器。
* **主要元素**：当前容器内的组件。
* **支撑元素**：容器（在软件系统范围内）以及直接连接到组件的人员和软件系统。
* **目标受众**：软件架构师及开发人员。

##### 2.3.3.2 示例

这是一个虚构的网上银行系统的组件图，显示了API应用程序中的一些（而不是全部）组件。这里有三个Spring MVC Rest控制器为JSON/HTTPS API提供访问点，每个控制器随后使用其他组件从数据库和大型机银行系统访问数据，或发送电子邮件。

虚线表示API应用程序的边界，显示其中的组件（浅蓝色）。

![Component diagram](https://c4model.com/img/bigbankplc-Components.png)

#### 2.3.4 第四层：Code diagram，代码图

![Code diagram](https://c4model.com/img/bigbankplc-Classes.png)

最后，可以放大每个组件，以显示它是如何作为代码实现的；使用UML类图、实体关系图等。

这是一个可选的详细级别，通常可以从IDE等工具生成。理想情况下，该图将使用工具（例如IDE或UML建模工具）自动生成，此时应该考虑只显示那些重要业务背景或逻辑的属性和方法。对于最重要或最复杂的组件，不建议使用此级别的详细信息。

* **应用范围**：单独的组件。
* **主要元素**：组件内的代码元素（例如类、接口、对象、函数、数据库表等）。
* **目标受众**：软件架构师及开发人员。

### 2.4 附加图

#### 2.4.1 System Landscape diagram，系统场景图

![System Landscape diagram](https://c4model.com/img/bigbankplc-SystemLandscape.png)

`C4模型`提供了单个软件系统的静态图，但在现实世界中，软件系统从来不会孤立存在。出于这个原因，了解所有这些软件系统如何在企业范围内组合在一起通常是很有用的。为此，只需在C4图中添加另一个图，从IT角度显示系统的场景。与系统概念图一样，该图可以显示组织边界、内部/外部用户和内部/外部系统。

本质上，这是一个企业级软件系统的高级映射，每个软件系统都可以使用`C4模型`向下分解。从实际的角度来看，`系统场景图`实际上只是一个系统概念图，没有对特定软件系统的特定关注。

* **应用范围**：整个企业或应用范围。
* **主要元素**：在整个应用范围有关联的人员和软件系统。
* **目标受众**：软件开发团队内外的所有人，包括技术人员和非技术人员。

#### 2.4.2 Dynamic diagram，动态图

![Dynamic diagram](https://c4model.com/img/bigbankplc-SignIn.png)

当需要展示静态模型中的元素如何在运行时协作来实现用户用例、特性等时，`动态图`是很有用的。这个动态图基于UML协作图。它类似于UML序列图，但它允许图元素的自由形式排列，带有编号的交互来指示顺序。

* **应用范围**：整个企业或应用范围、单独的软件系统、容器。
* **主要元素和支撑元素**：取决于关系图的范围。企业（请参阅系统场景图）、软件系统（请参阅概念图或容器图）、容器（请参阅组件图）。
* **目标受众**：软件开发团队内外的所有人，包括技术人员和非技术人员。

#### 2.4.3 Deployment diagram，部署图

![Deployment diagram](https://c4model.com/img/bigbankplc-LiveDeployment.png)

`部署图`说明如何将静态模型中的容器映射到基础设施。这个部署图基于`UML部署图`，只是简化了一下，以显示容器和部署节点之间的映射关系。部署节点类似于物理基础设施（例如物理服务器或设备）、虚拟化基础设施（例如IaaS、PaaS、虚拟机）、容器化基础设施（例如Docker容器）、执行环境（例如数据库服务器、Java EE web/应用程序服务器、Microsoft IIS），部署节点可以嵌套。

`部署图`还可以包括基础设施节点，如DNS服务、负载平衡器、防火墙等。

* **应用范围**：单独的软件系统。
* **主要元素**：软件系统范围内的部署节点和容器。
* **支撑元素**：软件系统部署中使用的基础结构节点。
* **目标受众**：软件开发团队内外的技术人员；包括软件架构师、开发人员、基础设施架构师和操作/支持人员。

## 三、 绘图建议

### 3.1 视图

* 每个图都应该有一个描述图类型和范围的标题（例如`XX软件系统的概念图`）。
* 每个图都应该有一个图例来解释所使用的符号（例如形状、颜色、边框样式、线型、箭头等）。
* 缩略语（业务/领域或技术）应为所有受众所理解，或在图例中解释。

### 3.2 图中的元素

* 每个元素的类型都应明确规定（如人员、软件系统、容器或组件）。
* 每个元素都应该有一个简短的描述，以使关键职责`一目了然`。
* 每个容器和组件都应该有指定明确的技术。

### 3.3 元素间的关系

* 每一条线都应该代表一个单向关系。
* 每一条线都应该贴上标签。标签与关系的方向和意图一致（例如依赖关系或数据流）。标签尽量具体，最好避免使用诸如`使用`这样的单字。
* 容器之间的关系（通常表示进程间通信）应该明确标记使用的技术/协议。

## 四、 更多的示例

* [Big Bank plc](https://structurizr.com/share/36141#SystemContext)：系统场景图、概念图、容器图、组件图、动态图和部署图。
* [Financial Risk System](https://structurizr.com/share/31)：概念图。
* [Spring PetClinic](https://structurizr.com/share/1#components)：概念图、容器图、组件图、动态图和部署图。
* [Message bus and micro services](https://structurizr.com/share/4241#CustomerUpdateEvent)：容器图和动态图。
